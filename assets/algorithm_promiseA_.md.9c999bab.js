import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.82820f36.js";const E=JSON.parse('{"title":"promiseA+","description":"","frontmatter":{},"headers":[],"relativePath":"algorithm/promiseA+.md","filePath":"algorithm/promiseA+.md","lastUpdated":1723977222000}'),p={name:"algorithm/promiseA+.md"},o=l(`<h1 id="promisea" tabindex="-1">promiseA+ <a class="header-anchor" href="#promisea" aria-label="Permalink to &quot;promiseA+&quot;">​</a></h1><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#758575DD;">/**</span></span>
<span class="line"><span style="color:#758575DD;"> * 1. new Promise时，需要传递一个 executor 执行器，执行器立刻执行</span></span>
<span class="line"><span style="color:#758575DD;"> * 2. executor 接受两个参数，分别是 resolve 和 reject</span></span>
<span class="line"><span style="color:#758575DD;"> * 3. promise 只能从 pending 到 rejected, 或者从 pending 到 fulfilled</span></span>
<span class="line"><span style="color:#758575DD;"> * 4. promise 的状态一旦确认，就不会再改变</span></span>
<span class="line"><span style="color:#758575DD;"> * 5. promise 都有 then 方法，then 接收两个参数，分别是 promise 成功的回调 onFulfilled, </span></span>
<span class="line"><span style="color:#758575DD;"> *      和 promise 失败的回调 onRejected</span></span>
<span class="line"><span style="color:#758575DD;"> * 6. 如果调用 then 时，promise已经成功，则执行 onFulfilled，并将promise的值作为参数传递进去。</span></span>
<span class="line"><span style="color:#758575DD;"> *      如果promise已经失败，那么执行 onRejected, 并将 promise 失败的原因作为参数传递进去。</span></span>
<span class="line"><span style="color:#758575DD;"> *      如果promise的状态是pending，需要将onFulfilled和onRejected函数存放起来，等待状态确定后，再依次将对应的函数执行(发布订阅)</span></span>
<span class="line"><span style="color:#758575DD;"> * 7. then 的参数 onFulfilled 和 onRejected 可以缺省</span></span>
<span class="line"><span style="color:#758575DD;"> * 8. promise 可以then多次，promise 的then 方法返回一个 promise</span></span>
<span class="line"><span style="color:#758575DD;"> * 9. 如果 then 返回的是一个结果，那么就会把这个结果作为参数，传递给下一个then的成功的回调(onFulfilled)</span></span>
<span class="line"><span style="color:#758575DD;"> * 10. 如果 then 中抛出了异常，那么就会把这个异常作为参数，传递给下一个then的失败的回调(onRejected)</span></span>
<span class="line"><span style="color:#758575DD;"> * 11.如果 then 返回的是一个promise，那么会等这个promise执行完，promise如果成功，</span></span>
<span class="line"><span style="color:#758575DD;"> *   就走下一个then的成功，如果失败，就走下一个then的失败</span></span>
<span class="line"><span style="color:#758575DD;"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">PENDING</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">pending</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FULFILLED</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">fulfilled</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">const</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">REJECTED</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">rejected</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">Promise</span><span style="color:#666666;">(</span><span style="color:#BD976A;">executor</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">self</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">status</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">PENDING</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">onFulfilled</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[];</span><span style="color:#758575DD;">//成功的回调</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">onRejected</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">[];</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//失败的回调</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">//PromiseA+ 2.1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">value</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">status</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">PENDING</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">status</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FULFILLED</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">value</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">value</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">onFulfilled</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">(</span><span style="color:#BD976A;">fn</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">fn</span><span style="color:#666666;">());</span><span style="color:#758575DD;">//PromiseA+ 2.2.6.1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">reject</span><span style="color:#666666;">(</span><span style="color:#BD976A;">reason</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">status</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">PENDING</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">status</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">REJECTED</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">reason</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reason</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">onRejected</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">(</span><span style="color:#BD976A;">fn</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">fn</span><span style="color:#666666;">());</span><span style="color:#758575DD;">//PromiseA+ 2.2.6.2</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">try</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">executor</span><span style="color:#666666;">(</span><span style="color:#BD976A;">resolve</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reject</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">catch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">reject</span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">Promise</span><span style="color:#666666;">.</span><span style="color:#B8A965;">prototype</span><span style="color:#666666;">.</span><span style="color:#80A665;">then</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">onFulfilled</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">onRejected</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">//PromiseA+ 2.2.1 / PromiseA+ 2.2.5 / PromiseA+ 2.2.7.3 / PromiseA+ 2.2.7.4</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">onFulfilled</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">onFulfilled</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">function</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">onFulfilled</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">value</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">value</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">onRejected</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">onRejected</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">function</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">?</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">onRejected</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reason</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">throw</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reason</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">self</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">//PromiseA+ 2.2.7</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">promise2</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">Promise</span><span style="color:#666666;">((</span><span style="color:#BD976A;">resolve</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reject</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">status</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">FULFILLED</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">//PromiseA+ 2.2.2</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">//PromiseA+ 2.2.4 --- setTimeout</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">setTimeout</span><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">try</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">//PromiseA+ 2.2.7.1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">onFulfilled</span><span style="color:#666666;">(</span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">value</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#80A665;">resolvePromise</span><span style="color:#666666;">(</span><span style="color:#BD976A;">promise2</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resolve</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reject</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">catch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">//PromiseA+ 2.2.7.2</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#80A665;">reject</span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">status</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">REJECTED</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">//PromiseA+ 2.2.3</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">setTimeout</span><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">try</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">onRejected</span><span style="color:#666666;">(</span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">reason</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#80A665;">resolvePromise</span><span style="color:#666666;">(</span><span style="color:#BD976A;">promise2</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resolve</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reject</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">catch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#80A665;">reject</span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">status</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">PENDING</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">onFulfilled</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">setTimeout</span><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#4D9375;">try</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">onFulfilled</span><span style="color:#666666;">(</span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">value</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#80A665;">resolvePromise</span><span style="color:#666666;">(</span><span style="color:#BD976A;">promise2</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resolve</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reject</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">catch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#80A665;">reject</span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">onRejected</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">setTimeout</span><span style="color:#666666;">(()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#4D9375;">try</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">onRejected</span><span style="color:#666666;">(</span><span style="color:#BD976A;">self</span><span style="color:#666666;">.</span><span style="color:#BD976A;">reason</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#80A665;">resolvePromise</span><span style="color:#666666;">(</span><span style="color:#BD976A;">promise2</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resolve</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reject</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">catch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                        </span><span style="color:#80A665;">reject</span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">promise2</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">resolvePromise</span><span style="color:#666666;">(</span><span style="color:#BD976A;">promise2</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resolve</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reject</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">self</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">this</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">//PromiseA+ 2.3.1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">promise2</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">reject</span><span style="color:#666666;">(</span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">TypeError</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">Chaining cycle</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">));</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">x</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">object</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">||</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">function</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">used</span><span style="color:#666666;">;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//PromiseA+2.3.3.3.3 只能调用一次</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#4D9375;">try</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">then</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">x</span><span style="color:#666666;">.</span><span style="color:#BD976A;">then</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">typeof</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">then</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">===</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">function</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">//PromiseA+2.3.3</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">then</span><span style="color:#666666;">.</span><span style="color:#80A665;">call</span><span style="color:#666666;">(</span><span style="color:#BD976A;">x</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">y</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">//PromiseA+2.3.3.1</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">used</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">used</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#80A665;">resolvePromise</span><span style="color:#666666;">(</span><span style="color:#BD976A;">promise2</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">y</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resolve</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reject</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">},</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">r</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                    </span><span style="color:#758575DD;">//PromiseA+2.3.3.2</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">used</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#BD976A;">used</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                    </span><span style="color:#80A665;">reject</span><span style="color:#666666;">(</span><span style="color:#BD976A;">r</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#666666;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span><span style="color:#4D9375;">else</span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">                </span><span style="color:#758575DD;">//PromiseA+2.3.3.4</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">used</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#BD976A;">used</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">                </span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">x</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">catch</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">//PromiseA+ 2.3.3.2</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#4D9375;">if</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">used</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">return</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#BD976A;">used</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">true</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">            </span><span style="color:#80A665;">reject</span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">else</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">//PromiseA+ 2.3.3.4</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#80A665;">resolve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">x</span><span style="color:#666666;">);</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">Promise</span><span style="color:#666666;">.</span><span style="color:#BD976A;">defer</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">Promise</span><span style="color:#666666;">.</span><span style="color:#80A665;">deferred</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">function</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">()</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#CB7676;">let</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dfd</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{};</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#BD976A;">dfd</span><span style="color:#666666;">.</span><span style="color:#BD976A;">promise</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">new</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">Promise</span><span style="color:#666666;">((</span><span style="color:#BD976A;">resolve</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reject</span><span style="color:#666666;">)</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">dfd</span><span style="color:#666666;">.</span><span style="color:#BD976A;">resolve</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">resolve</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">        </span><span style="color:#BD976A;">dfd</span><span style="color:#666666;">.</span><span style="color:#BD976A;">reject</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">reject</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#666666;">});</span></span>
<span class="line"><span style="color:#DBD7CAEE;">    </span><span style="color:#4D9375;">return</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">dfd</span><span style="color:#666666;">;</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B8A965;">module</span><span style="color:#666666;">.</span><span style="color:#B8A965;">exports</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#B8A965;">Promise</span><span style="color:#666666;">;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#A0ADA0;">/**</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 1. new Promise时，需要传递一个 executor 执行器，执行器立刻执行</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 2. executor 接受两个参数，分别是 resolve 和 reject</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 3. promise 只能从 pending 到 rejected, 或者从 pending 到 fulfilled</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 4. promise 的状态一旦确认，就不会再改变</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 5. promise 都有 then 方法，then 接收两个参数，分别是 promise 成功的回调 onFulfilled, </span></span>
<span class="line"><span style="color:#A0ADA0;"> *      和 promise 失败的回调 onRejected</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 6. 如果调用 then 时，promise已经成功，则执行 onFulfilled，并将promise的值作为参数传递进去。</span></span>
<span class="line"><span style="color:#A0ADA0;"> *      如果promise已经失败，那么执行 onRejected, 并将 promise 失败的原因作为参数传递进去。</span></span>
<span class="line"><span style="color:#A0ADA0;"> *      如果promise的状态是pending，需要将onFulfilled和onRejected函数存放起来，等待状态确定后，再依次将对应的函数执行(发布订阅)</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 7. then 的参数 onFulfilled 和 onRejected 可以缺省</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 8. promise 可以then多次，promise 的then 方法返回一个 promise</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 9. 如果 then 返回的是一个结果，那么就会把这个结果作为参数，传递给下一个then的成功的回调(onFulfilled)</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 10. 如果 then 中抛出了异常，那么就会把这个异常作为参数，传递给下一个then的失败的回调(onRejected)</span></span>
<span class="line"><span style="color:#A0ADA0;"> * 11.如果 then 返回的是一个promise，那么会等这个promise执行完，promise如果成功，</span></span>
<span class="line"><span style="color:#A0ADA0;"> *   就走下一个then的成功，如果失败，就走下一个then的失败</span></span>
<span class="line"><span style="color:#A0ADA0;"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">PENDING</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">pending</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FULFILLED</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">fulfilled</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">const</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">REJECTED</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">rejected</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">Promise</span><span style="color:#999999;">(</span><span style="color:#B07D48;">executor</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">self</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">status</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">PENDING</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">onFulfilled</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[];</span><span style="color:#A0ADA0;">//成功的回调</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">onRejected</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">[];</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//失败的回调</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">//PromiseA+ 2.1</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">value</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">status</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">PENDING</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">status</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FULFILLED</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">value</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">value</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">onFulfilled</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">(</span><span style="color:#B07D48;">fn</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#59873A;">fn</span><span style="color:#999999;">());</span><span style="color:#A0ADA0;">//PromiseA+ 2.2.6.1</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">reject</span><span style="color:#999999;">(</span><span style="color:#B07D48;">reason</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">status</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">PENDING</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">status</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">REJECTED</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">reason</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reason</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">onRejected</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">(</span><span style="color:#B07D48;">fn</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#59873A;">fn</span><span style="color:#999999;">());</span><span style="color:#A0ADA0;">//PromiseA+ 2.2.6.2</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">try</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">executor</span><span style="color:#999999;">(</span><span style="color:#B07D48;">resolve</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reject</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">catch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">reject</span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">Promise</span><span style="color:#999999;">.</span><span style="color:#998418;">prototype</span><span style="color:#999999;">.</span><span style="color:#59873A;">then</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">onFulfilled</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">onRejected</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">//PromiseA+ 2.2.1 / PromiseA+ 2.2.5 / PromiseA+ 2.2.7.3 / PromiseA+ 2.2.7.4</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">onFulfilled</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">onFulfilled</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">function</span><span style="color:#B5695999;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">onFulfilled</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">value</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">value</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">onRejected</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">onRejected</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">function</span><span style="color:#B5695999;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">?</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">onRejected</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reason</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">throw</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reason</span><span style="color:#393A34;"> </span><span style="color:#999999;">};</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">self</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">//PromiseA+ 2.2.7</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">promise2</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#998418;">Promise</span><span style="color:#999999;">((</span><span style="color:#B07D48;">resolve</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reject</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">status</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">FULFILLED</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">//PromiseA+ 2.2.2</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">//PromiseA+ 2.2.4 --- setTimeout</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">setTimeout</span><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">try</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">//PromiseA+ 2.2.7.1</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">onFulfilled</span><span style="color:#999999;">(</span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">value</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#59873A;">resolvePromise</span><span style="color:#999999;">(</span><span style="color:#B07D48;">promise2</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resolve</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reject</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">catch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">//PromiseA+ 2.2.7.2</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#59873A;">reject</span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">status</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">REJECTED</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">//PromiseA+ 2.2.3</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">setTimeout</span><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">try</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">onRejected</span><span style="color:#999999;">(</span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">reason</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#59873A;">resolvePromise</span><span style="color:#999999;">(</span><span style="color:#B07D48;">promise2</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resolve</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reject</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">catch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#59873A;">reject</span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">status</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">PENDING</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">onFulfilled</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">setTimeout</span><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#1E754F;">try</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">onFulfilled</span><span style="color:#999999;">(</span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">value</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#59873A;">resolvePromise</span><span style="color:#999999;">(</span><span style="color:#B07D48;">promise2</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resolve</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reject</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">catch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#59873A;">reject</span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">onRejected</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">setTimeout</span><span style="color:#999999;">(()</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#1E754F;">try</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#59873A;">onRejected</span><span style="color:#999999;">(</span><span style="color:#B07D48;">self</span><span style="color:#999999;">.</span><span style="color:#B07D48;">reason</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#59873A;">resolvePromise</span><span style="color:#999999;">(</span><span style="color:#B07D48;">promise2</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resolve</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reject</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">catch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">                        </span><span style="color:#59873A;">reject</span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">promise2</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#59873A;">resolvePromise</span><span style="color:#999999;">(</span><span style="color:#B07D48;">promise2</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resolve</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reject</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">self</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">this</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">//PromiseA+ 2.3.1</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">promise2</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">reject</span><span style="color:#999999;">(</span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#59873A;">TypeError</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">Chaining cycle</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">));</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">x</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">object</span><span style="color:#B5695999;">&#39;</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">||</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">function</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">used</span><span style="color:#999999;">;</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//PromiseA+2.3.3.3.3 只能调用一次</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#1E754F;">try</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">then</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">x</span><span style="color:#999999;">.</span><span style="color:#B07D48;">then</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">typeof</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">then</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">===</span><span style="color:#393A34;"> </span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">function</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">//PromiseA+2.3.3</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">then</span><span style="color:#999999;">.</span><span style="color:#59873A;">call</span><span style="color:#999999;">(</span><span style="color:#B07D48;">x</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">y</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">//PromiseA+2.3.3.1</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">used</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">used</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#59873A;">resolvePromise</span><span style="color:#999999;">(</span><span style="color:#B07D48;">promise2</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">y</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resolve</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reject</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">},</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">r</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                    </span><span style="color:#A0ADA0;">//PromiseA+2.3.3.2</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">used</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#B07D48;">used</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                    </span><span style="color:#59873A;">reject</span><span style="color:#999999;">(</span><span style="color:#B07D48;">r</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#999999;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span><span style="color:#1E754F;">else</span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">                </span><span style="color:#A0ADA0;">//PromiseA+2.3.3.4</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">used</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#B07D48;">used</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">                </span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">x</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">catch</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">//PromiseA+ 2.3.3.2</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#1E754F;">if</span><span style="color:#393A34;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">used</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">return</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#B07D48;">used</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">true</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">            </span><span style="color:#59873A;">reject</span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">else</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">//PromiseA+ 2.3.3.4</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#59873A;">resolve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">x</span><span style="color:#999999;">);</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">Promise</span><span style="color:#999999;">.</span><span style="color:#B07D48;">defer</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#998418;">Promise</span><span style="color:#999999;">.</span><span style="color:#59873A;">deferred</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">function</span><span style="color:#393A34;"> </span><span style="color:#999999;">()</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#AB5959;">let</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dfd</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#999999;">{};</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#B07D48;">dfd</span><span style="color:#999999;">.</span><span style="color:#B07D48;">promise</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">new</span><span style="color:#393A34;"> </span><span style="color:#998418;">Promise</span><span style="color:#999999;">((</span><span style="color:#B07D48;">resolve</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reject</span><span style="color:#999999;">)</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">dfd</span><span style="color:#999999;">.</span><span style="color:#B07D48;">resolve</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">resolve</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">        </span><span style="color:#B07D48;">dfd</span><span style="color:#999999;">.</span><span style="color:#B07D48;">reject</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">reject</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#999999;">});</span></span>
<span class="line"><span style="color:#393A34;">    </span><span style="color:#1E754F;">return</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">dfd</span><span style="color:#999999;">;</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;">module</span><span style="color:#999999;">.</span><span style="color:#998418;">exports</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#998418;">Promise</span><span style="color:#999999;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br></div></div><p>安装测试脚本:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#80A665;">npm</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D;">install</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C99076;">-g</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D;">promises-aplus-tests</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#59873A;">npm</span><span style="color:#393A34;"> </span><span style="color:#B56959;">install</span><span style="color:#393A34;"> </span><span style="color:#A65E2B;">-g</span><span style="color:#393A34;"> </span><span style="color:#B56959;">promises-aplus-tests</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>在对应的目录执行以下命令:</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#80A665;">promises-aplus-tests</span><span style="color:#DBD7CAEE;"> </span><span style="color:#C98A7D;">promise.js</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#59873A;">promises-aplus-tests</span><span style="color:#393A34;"> </span><span style="color:#B56959;">promise.js</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>对上面的代码实现做一点简要说明(其它一些内容注释中已经写得很清楚):</p><p>onFulfilled 和 onFulfilled的调用需要放在setTimeout，因为规范中表示: onFulfilled or onRejected must not be called until the execution context stack contains only platform code。使用setTimeout只是模拟异步，原生Promise并非是这样实现的。</p><p>在 resolvePromise 的函数中，为何需要usedd这个flag,同样是因为规范中明确表示: If both resolvePromise and rejectPromise are called, or multiple calls to the same argument are made, the first call takes precedence, and any further calls are ignored. 因此我们需要这样的flag来确保只会执行一次。</p><p>self.onFulfilled 和 self.onRejected 中存储了成功的回调和失败的回调，根据规范2.6显示，当promise从pending态改变的时候，需要按照顺序去指定then对应的回调。</p><h2 id="_2-1-promise-states" tabindex="-1">2.1 Promise States <a class="header-anchor" href="#_2-1-promise-states" aria-label="Permalink to &quot;2.1 Promise States&quot;">​</a></h2><p>Promise 必须处于以下三个状态之一: pending, fulfilled 或者是 rejected</p><h3 id="_2-1-1-如果promise在pending状态" tabindex="-1">2.1.1 如果promise在pending状态 <a class="header-anchor" href="#_2-1-1-如果promise在pending状态" aria-label="Permalink to &quot;2.1.1 如果promise在pending状态&quot;">​</a></h3><p>代码解读复制代码2.1.1.1 可以变成 fulfilled 或者是 rejected</p><h3 id="_2-1-2-如果promise在fulfilled状态" tabindex="-1">2.1.2 如果promise在fulfilled状态 <a class="header-anchor" href="#_2-1-2-如果promise在fulfilled状态" aria-label="Permalink to &quot;2.1.2 如果promise在fulfilled状态&quot;">​</a></h3><p>代码解读复制代码2.1.2.1 不会变成其它状态</p><h3 id="_2-1-2-2-必须有一个value值" tabindex="-1">2.1.2.2 必须有一个value值 <a class="header-anchor" href="#_2-1-2-2-必须有一个value值" aria-label="Permalink to &quot;2.1.2.2 必须有一个value值&quot;">​</a></h3><h3 id="_2-1-3-如果promise在rejected状态" tabindex="-1">2.1.3 如果promise在rejected状态 <a class="header-anchor" href="#_2-1-3-如果promise在rejected状态" aria-label="Permalink to &quot;2.1.3 如果promise在rejected状态&quot;">​</a></h3><p>代码解读复制代码2.1.3.1 不会变成其它状态</p><h3 id="_2-1-3-2-必须有一个promise被reject的reason" tabindex="-1">2.1.3.2 必须有一个promise被reject的reason <a class="header-anchor" href="#_2-1-3-2-必须有一个promise被reject的reason" aria-label="Permalink to &quot;2.1.3.2 必须有一个promise被reject的reason&quot;">​</a></h3><p>概括即是:promise的状态只能从pending变成fulfilled，或者从pending变成rejected.promise成功，有成功的value.promise失败的话，有失败的原因</p><h2 id="_2-2-then方法" tabindex="-1">2.2 then方法 <a class="header-anchor" href="#_2-2-then方法" aria-label="Permalink to &quot;2.2 then方法&quot;">​</a></h2><p>promise必须提供一个then方法，来访问最终的结果 promise的then方法接收两个参数 代码解读复制代码promise.then(onFulfilled, onRejected)</p><h3 id="_2-2-1-onfulfilled-和-onrejected-都是可选参数" tabindex="-1">2.2.1 onFulfilled 和 onRejected 都是可选参数 <a class="header-anchor" href="#_2-2-1-onfulfilled-和-onrejected-都是可选参数" aria-label="Permalink to &quot;2.2.1 onFulfilled 和 onRejected 都是可选参数&quot;">​</a></h3><p>代码解读复制代码2.2.1.1 onFulfilled 必须是函数类型</p><h3 id="_2-2-1-2-onrejected-必须是函数类型" tabindex="-1">2.2.1.2 onRejected 必须是函数类型 <a class="header-anchor" href="#_2-2-1-2-onrejected-必须是函数类型" aria-label="Permalink to &quot;2.2.1.2 onRejected 必须是函数类型&quot;">​</a></h3><h3 id="_2-2-2-如果-onfulfilled-是函数" tabindex="-1">2.2.2 如果 onFulfilled 是函数: <a class="header-anchor" href="#_2-2-2-如果-onfulfilled-是函数" aria-label="Permalink to &quot;2.2.2 如果 onFulfilled 是函数:&quot;">​</a></h3><p>代码解读复制代码2.2.2.1 必须在promise变成 fulfilled 时，调用 onFulfilled，参数是promise的value</p><h3 id="_2-2-2-2-在promise的状态不是-fulfilled-之前-不能调用" tabindex="-1">2.2.2.2 在promise的状态不是 fulfilled 之前，不能调用 <a class="header-anchor" href="#_2-2-2-2-在promise的状态不是-fulfilled-之前-不能调用" aria-label="Permalink to &quot;2.2.2.2 在promise的状态不是 fulfilled 之前，不能调用&quot;">​</a></h3><h3 id="_2-2-2-3-onfulfilled-只能被调用一次" tabindex="-1">2.2.2.3 onFulfilled 只能被调用一次 <a class="header-anchor" href="#_2-2-2-3-onfulfilled-只能被调用一次" aria-label="Permalink to &quot;2.2.2.3 onFulfilled 只能被调用一次&quot;">​</a></h3><h3 id="_2-2-3-如果-onrejected-是函数" tabindex="-1">2.2.3 如果 onRejected 是函数: <a class="header-anchor" href="#_2-2-3-如果-onrejected-是函数" aria-label="Permalink to &quot;2.2.3 如果 onRejected 是函数:&quot;">​</a></h3><p>代码解读复制代码2.2.3.1 必须在promise变成 rejected 时，调用 onRejected，参数是promise的reason</p><h3 id="_2-2-3-2-在promise的状态不是-rejected-之前-不能调用" tabindex="-1">2.2.3.2 在promise的状态不是 rejected 之前，不能调用 <a class="header-anchor" href="#_2-2-3-2-在promise的状态不是-rejected-之前-不能调用" aria-label="Permalink to &quot;2.2.3.2 在promise的状态不是 rejected 之前，不能调用&quot;">​</a></h3><h3 id="_2-2-3-3-onrejected-只能被调用一次" tabindex="-1">2.2.3.3 onRejected 只能被调用一次 <a class="header-anchor" href="#_2-2-3-3-onrejected-只能被调用一次" aria-label="Permalink to &quot;2.2.3.3 onRejected 只能被调用一次&quot;">​</a></h3><h3 id="_2-2-4-onfulfilled-和-onrejected-应该是微任务" tabindex="-1">2.2.4 onFulfilled 和 onRejected 应该是微任务 <a class="header-anchor" href="#_2-2-4-onfulfilled-和-onrejected-应该是微任务" aria-label="Permalink to &quot;2.2.4 onFulfilled 和 onRejected 应该是微任务&quot;">​</a></h3><h3 id="_2-2-5-onfulfilled-和-onrejected-必须作为函数被调用" tabindex="-1">2.2.5 onFulfilled 和 onRejected 必须作为函数被调用 <a class="header-anchor" href="#_2-2-5-onfulfilled-和-onrejected-必须作为函数被调用" aria-label="Permalink to &quot;2.2.5 onFulfilled  和 onRejected 必须作为函数被调用&quot;">​</a></h3><h3 id="_2-2-6-then方法可能被多次调用" tabindex="-1">2.2.6 then方法可能被多次调用 <a class="header-anchor" href="#_2-2-6-then方法可能被多次调用" aria-label="Permalink to &quot;2.2.6 then方法可能被多次调用&quot;">​</a></h3><p>代码解读复制代码2.2.6.1 如果promise变成了 fulfilled态，所有的onFulfilled回调都需要按照then的顺序执行</p><h3 id="_2-2-6-2-如果promise变成了-rejected态-所有的onrejected回调都需要按照then的顺序执行" tabindex="-1">2.2.6.2 如果promise变成了 rejected态，所有的onRejected回调都需要按照then的顺序执行 <a class="header-anchor" href="#_2-2-6-2-如果promise变成了-rejected态-所有的onrejected回调都需要按照then的顺序执行" aria-label="Permalink to &quot;2.2.6.2 如果promise变成了 rejected态，所有的onRejected回调都需要按照then的顺序执行&quot;">​</a></h3><h3 id="_2-2-7-then必须返回一个promise" tabindex="-1">2.2.7 then必须返回一个promise <a class="header-anchor" href="#_2-2-7-then必须返回一个promise" aria-label="Permalink to &quot;2.2.7 then必须返回一个promise&quot;">​</a></h3><p>代码解读复制代码promise2 = promise1.then(onFulfilled, onRejected); 代码解读复制代码2.2.7.1 onFulfilled 或 onRejected 执行的结果为x,调用 resolvePromise</p><h3 id="_2-2-7-2-如果-onfulfilled-或者-onrejected-执行时抛出异常e-promise2需要被reject" tabindex="-1">2.2.7.2 如果 onFulfilled 或者 onRejected 执行时抛出异常e,promise2需要被reject <a class="header-anchor" href="#_2-2-7-2-如果-onfulfilled-或者-onrejected-执行时抛出异常e-promise2需要被reject" aria-label="Permalink to &quot;2.2.7.2 如果 onFulfilled 或者 onRejected 执行时抛出异常e,promise2需要被reject&quot;">​</a></h3><h3 id="_2-2-7-3-如果-onfulfilled-不是一个函数-promise2-以promise1的值fulfilled" tabindex="-1">2.2.7.3 如果 onFulfilled 不是一个函数，promise2 以promise1的值fulfilled <a class="header-anchor" href="#_2-2-7-3-如果-onfulfilled-不是一个函数-promise2-以promise1的值fulfilled" aria-label="Permalink to &quot;2.2.7.3 如果 onFulfilled 不是一个函数，promise2 以promise1的值fulfilled&quot;">​</a></h3><h3 id="_2-2-7-4-如果-onrejected-不是一个函数-promise2-以promise1的reason-rejected" tabindex="-1">2.2.7.4 如果 onRejected 不是一个函数，promise2 以promise1的reason rejected <a class="header-anchor" href="#_2-2-7-4-如果-onrejected-不是一个函数-promise2-以promise1的reason-rejected" aria-label="Permalink to &quot;2.2.7.4 如果 onRejected 不是一个函数，promise2 以promise1的reason rejected&quot;">​</a></h3><h2 id="_2-3-resolvepromise" tabindex="-1">2.3 resolvePromise <a class="header-anchor" href="#_2-3-resolvepromise" aria-label="Permalink to &quot;2.3 resolvePromise&quot;">​</a></h2><p>resolvePromise(promise2, x, resolve, reject)</p><h3 id="_2-3-1-如果-promise2-和-x-相等-那么-reject-promise-with-a-typeerror" tabindex="-1">2.3.1 如果 promise2 和 x 相等，那么 reject promise with a TypeError <a class="header-anchor" href="#_2-3-1-如果-promise2-和-x-相等-那么-reject-promise-with-a-typeerror" aria-label="Permalink to &quot;2.3.1 如果 promise2 和 x 相等，那么 reject promise with a TypeError&quot;">​</a></h3><h3 id="_2-3-2-如果-x-是一个-promsie" tabindex="-1">2.3.2 如果 x 是一个 promsie <a class="header-anchor" href="#_2-3-2-如果-x-是一个-promsie" aria-label="Permalink to &quot;2.3.2 如果 x 是一个 promsie&quot;">​</a></h3><p>代码解读复制代码2.3.2.1 如果x是pending态，那么promise必须要在pending,直到 x 变成 fulfilled or rejected.</p><h3 id="_2-3-2-2-如果-x-被-fulfilled-fulfill-promise-with-the-same-value" tabindex="-1">2.3.2.2 如果 x 被 fulfilled, fulfill promise with the same value. <a class="header-anchor" href="#_2-3-2-2-如果-x-被-fulfilled-fulfill-promise-with-the-same-value" aria-label="Permalink to &quot;2.3.2.2 如果 x 被 fulfilled, fulfill promise with the same value.&quot;">​</a></h3><h3 id="_2-3-2-3-如果-x-被-rejected-reject-promise-with-the-same-reason" tabindex="-1">2.3.2.3 如果 x 被 rejected, reject promise with the same reason. <a class="header-anchor" href="#_2-3-2-3-如果-x-被-rejected-reject-promise-with-the-same-reason" aria-label="Permalink to &quot;2.3.2.3 如果 x 被 rejected, reject promise with the same reason.&quot;">​</a></h3><h3 id="_2-3-3-如果-x-是一个-object-或者-是一个-function" tabindex="-1">2.3.3 如果 x 是一个 object 或者 是一个 function <a class="header-anchor" href="#_2-3-3-如果-x-是一个-object-或者-是一个-function" aria-label="Permalink to &quot;2.3.3 如果 x 是一个 object 或者 是一个 function&quot;">​</a></h3><p>代码解读复制代码2.3.3.1 let then = x.then.</p><h3 id="_2-3-3-2-如果-x-then-这步出错-那么-reject-promise-with-e-as-the-reason" tabindex="-1">2.3.3.2 如果 x.then 这步出错，那么 reject promise with e as the reason.. <a class="header-anchor" href="#_2-3-3-2-如果-x-then-这步出错-那么-reject-promise-with-e-as-the-reason" aria-label="Permalink to &quot;2.3.3.2 如果 x.then 这步出错，那么 reject promise with e as the reason..&quot;">​</a></h3><h3 id="_2-3-3-3-如果-then-是一个函数-then-call-x-resolvepromisefn-rejectpromise" tabindex="-1">2.3.3.3 如果 then 是一个函数，then.call(x, resolvePromiseFn, rejectPromise) <a class="header-anchor" href="#_2-3-3-3-如果-then-是一个函数-then-call-x-resolvepromisefn-rejectpromise" aria-label="Permalink to &quot;2.3.3.3 如果 then 是一个函数，then.call(x, resolvePromiseFn, rejectPromise)&quot;">​</a></h3><h3 id="_2-3-3-3-1-resolvepromisefn-的-入参是-y-执行-resolvepromise-promise2-y-resolve-reject" tabindex="-1">2.3.3.3.1 resolvePromiseFn 的 入参是 y, 执行 resolvePromise(promise2, y, resolve, reject); <a class="header-anchor" href="#_2-3-3-3-1-resolvepromisefn-的-入参是-y-执行-resolvepromise-promise2-y-resolve-reject" aria-label="Permalink to &quot;2.3.3.3.1 resolvePromiseFn 的 入参是 y, 执行 resolvePromise(promise2, y, resolve, reject);&quot;">​</a></h3><h3 id="_2-3-3-3-2-rejectpromise-的-入参是-r-reject-promise-with-r" tabindex="-1">2.3.3.3.2 rejectPromise 的 入参是 r, reject promise with r. <a class="header-anchor" href="#_2-3-3-3-2-rejectpromise-的-入参是-r-reject-promise-with-r" aria-label="Permalink to &quot;2.3.3.3.2 rejectPromise 的 入参是 r, reject promise with r.&quot;">​</a></h3><h3 id="_2-3-3-3-3-如果-resolvepromise-和-rejectpromise-都调用了-那么第一个调用优先-后面的调用忽略。" tabindex="-1">2.3.3.3.3 如果 resolvePromise 和 rejectPromise 都调用了，那么第一个调用优先，后面的调用忽略。 <a class="header-anchor" href="#_2-3-3-3-3-如果-resolvepromise-和-rejectpromise-都调用了-那么第一个调用优先-后面的调用忽略。" aria-label="Permalink to &quot;2.3.3.3.3 如果 resolvePromise 和 rejectPromise 都调用了，那么第一个调用优先，后面的调用忽略。&quot;">​</a></h3><h3 id="_2-3-3-3-4-如果调用then抛出异常e" tabindex="-1">2.3.3.3.4 如果调用then抛出异常e <a class="header-anchor" href="#_2-3-3-3-4-如果调用then抛出异常e" aria-label="Permalink to &quot;2.3.3.3.4 如果调用then抛出异常e&quot;">​</a></h3><h3 id="_2-3-3-3-4-1-如果-resolvepromise-或-rejectpromise-已经被调用-那么忽略" tabindex="-1">2.3.3.3.4.1 如果 resolvePromise 或 rejectPromise 已经被调用，那么忽略 <a class="header-anchor" href="#_2-3-3-3-4-1-如果-resolvepromise-或-rejectpromise-已经被调用-那么忽略" aria-label="Permalink to &quot;2.3.3.3.4.1 如果 resolvePromise 或 rejectPromise 已经被调用，那么忽略&quot;">​</a></h3><h3 id="_2-3-3-3-4-3-否则-reject-promise-with-e-as-the-reason" tabindex="-1">2.3.3.3.4.3 否则，reject promise with e as the reason <a class="header-anchor" href="#_2-3-3-3-4-3-否则-reject-promise-with-e-as-the-reason" aria-label="Permalink to &quot;2.3.3.3.4.3 否则，reject promise with e as the reason&quot;">​</a></h3><h3 id="_2-3-3-4-如果-then-不是一个function-fulfill-promise-with-x" tabindex="-1">2.3.3.4 如果 then 不是一个function. fulfill promise with x. <a class="header-anchor" href="#_2-3-3-4-如果-then-不是一个function-fulfill-promise-with-x" aria-label="Permalink to &quot;2.3.3.4 如果 then 不是一个function. fulfill promise with x.&quot;">​</a></h3><h3 id="_2-3-4-如果-x-不是一个-object-或者-function-fulfill-promise-with-x" tabindex="-1">2.3.4 如果 x 不是一个 object 或者 function，fulfill promise with x. <a class="header-anchor" href="#_2-3-4-如果-x-不是一个-object-或者-function-fulfill-promise-with-x" aria-label="Permalink to &quot;2.3.4 如果 x 不是一个 object 或者 function，fulfill promise with x.&quot;">​</a></h3>`,63),e=[o];function r(c,t,y,i,D,A){return n(),a("div",null,e)}const m=s(p,[["render",r]]);export{E as __pageData,m as default};
