import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.82820f36.js";const b=JSON.parse('{"title":"监控埋点","description":"","frontmatter":{},"headers":[],"relativePath":"study/maiDian.md","filePath":"study/maiDian.md","lastUpdated":1739638504000}'),p={name:"study/maiDian.md"},o=l(`<h1 id="监控埋点" tabindex="-1">监控埋点 <a class="header-anchor" href="#监控埋点" aria-label="Permalink to &quot;监控埋点&quot;">​</a></h1><h2 id="为什么使用前端埋点" tabindex="-1">为什么使用前端埋点？ <a class="header-anchor" href="#为什么使用前端埋点" aria-label="Permalink to &quot;为什么使用前端埋点？&quot;">​</a></h2><p>主要是为了收集产品数据，它的目的是上报相关行为数据，相关人员以数据为依据来分析产品在用户端的使用情况，根据分析出来的结果辅助产品优化、迭代、以及新需求的开发。</p><h2 id="目前项目埋点方面存在的痛点" tabindex="-1">目前项目埋点方面存在的痛点？ <a class="header-anchor" href="#目前项目埋点方面存在的痛点" aria-label="Permalink to &quot;目前项目埋点方面存在的痛点？&quot;">​</a></h2><ol><li><p>逻辑复用问题：特别是曝光相关的点需要在业务代码里面做额外的处理，所以逻辑复用很困难，对现有代码的侵入也很严重；</p></li><li><p>埋点在多个项目中分散存在，维护会比较麻烦。</p></li></ol><h2 id="前端埋点方案" tabindex="-1">前端埋点方案 <a class="header-anchor" href="#前端埋点方案" aria-label="Permalink to &quot;前端埋点方案&quot;">​</a></h2><p>目前主要有 3 种方案：</p><h3 id="手动代码埋点-用户触发某个动作后手动上报数据" tabindex="-1">手动代码埋点：用户触发某个动作后手动上报数据 <a class="header-anchor" href="#手动代码埋点-用户触发某个动作后手动上报数据" aria-label="Permalink to &quot;手动代码埋点：用户触发某个动作后手动上报数据&quot;">​</a></h3><p>优点：是最准确的，可以满足很多定制化的需求。</p><p>缺点：埋点逻辑与业务代码耦合到一起，不利于代码维护和复用。</p><h3 id="可视化埋点-通过可视化工具配置采集节点-指定自己想要监测的元素和属性。核心是查找-dom-然后绑定事件-业界比较有名的是-mixpanel、growingio、神策" tabindex="-1">可视化埋点：通过可视化工具配置采集节点，指定自己想要监测的元素和属性。核心是查找 dom 然后绑定事件，业界比较有名的是 Mixpanel、GrowingIO、神策 <a class="header-anchor" href="#可视化埋点-通过可视化工具配置采集节点-指定自己想要监测的元素和属性。核心是查找-dom-然后绑定事件-业界比较有名的是-mixpanel、growingio、神策" aria-label="Permalink to &quot;可视化埋点：通过可视化工具配置采集节点，指定自己想要监测的元素和属性。核心是查找 dom 然后绑定事件，业界比较有名的是 Mixpanel、GrowingIO、神策&quot;">​</a></h3><p>优点：可以做到按需配置，又不会像全埋点那样产生大量的无用数据。</p><p>缺点：比较难加载一些运行时参数；页面结构发生变化的时候，可能就需要进行部分重新配置。</p><h3 id="无埋点-也叫-全埋点-前端自动采集全部事件并上报埋点数据-在后端数据计算时过滤出有用数据" tabindex="-1">无埋点：也叫“全埋点”，前端自动采集全部事件并上报埋点数据，在后端数据计算时过滤出有用数据 <a class="header-anchor" href="#无埋点-也叫-全埋点-前端自动采集全部事件并上报埋点数据-在后端数据计算时过滤出有用数据" aria-label="Permalink to &quot;无埋点：也叫“全埋点”，前端自动采集全部事件并上报埋点数据，在后端数据计算时过滤出有用数据&quot;">​</a></h3><p>优点：收集用户的所有的行为，很全面。</p><p>缺点：无效的数据很多、上报数据量大。</p><h2 id="埋点方式" tabindex="-1">埋点方式 <a class="header-anchor" href="#埋点方式" aria-label="Permalink to &quot;埋点方式&quot;">​</a></h2><p>按照获取数据的方式一般分为三类：</p><p>页面埋点：统计用户进入或离开页面的各种维度信息，如页面浏览次数（PV）、浏览页面人数（UV）、页面停留时间、浏览器信息等。</p><p>点击埋点：统计用户在应用内的每一次点击事件，如报价列表的浏览次数、再次询价的次数等。</p><p>曝光埋点：统计具体区域是否被用户浏览到，如活动的引流入口的显示、投放广告的显示等</p><h2 id="埋点方案" tabindex="-1">埋点方案 <a class="header-anchor" href="#埋点方案" aria-label="Permalink to &quot;埋点方案&quot;">​</a></h2><p>目前我们项目中埋点需求主要有，点击埋点（dom点击）、页面埋点（主要是pv）。再根据我们目前选用的vue技术栈，所以考虑了以下两种实现方式：组件方式或者指令方式</p><p>点击埋点开始的是想提供一个组件，包裹需要进行点击埋点的 dom 元素，也有可能是组件，然后给子元素绑定点击事件，当用户触发事件时进行埋点相关处理。</p><p>但是这样就必须绑定点击事件到 dom 上，但是又不想在文档结构中引入额外的 dom 元素，因为这会增加 dom 结构层级，层级会变得更复杂。</p><p>所以最终采用了自定义指令的方式。</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">const </span><span style="color:#BD976A;">Point</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BD976A;">Point</span><span style="color:#666666;">.</span><span style="color:#80A665;">install</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Vue</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#DBD7CAEE;">  </span><span style="color:#BD976A;">Vue</span><span style="color:#666666;">.</span><span style="color:#80A665;">directive</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">point</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#80A665;">inserted</span><span style="color:#666666;"> (</span><span style="color:#BD976A;">el</span><span style="color:#666666;">, </span><span style="color:#BD976A;">binding</span><span style="color:#666666;">) {</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#CB7676;">const </span><span style="color:#BD976A;">data</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">binding</span><span style="color:#666666;">.</span><span style="color:#BD976A;">value</span></span>
<span class="line"><span style="color:#666666;">      </span><span style="color:#4D9375;">if</span><span style="color:#666666;"> (</span><span style="color:#BD976A;">data</span><span style="color:#666666;">) {</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#CB7676;">const </span><span style="color:#666666;">{</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">key</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">type</span><span style="color:#CB7676;"> </span><span style="color:#666666;">}</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">data</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#BD976A;">handler</span><span style="color:#666666;">[</span><span style="color:#BD976A;">type</span><span style="color:#666666;">](</span><span style="color:#BD976A;">key</span><span style="color:#666666;">, </span><span style="color:#BD976A;">el</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#666666;">      } </span><span style="color:#4D9375;">else</span><span style="color:#666666;"> {</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#4D9375;">throw</span><span style="color:#666666;"> </span><span style="color:#CB7676;">new</span><span style="color:#666666;"> </span><span style="color:#80A665;">Error</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">请补充正确的埋点参数</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#666666;">      }</span></span>
<span class="line"><span style="color:#666666;">    }</span></span>
<span class="line"><span style="color:#666666;">  },</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">false</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4D9375;">export</span><span style="color:#DBD7CAEE;"> </span><span style="color:#4D9375;">default</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">Point</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#666666;">&lt;</span><span style="color:#CB7676;">!--</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">点击埋点</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">--</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#666666;">&lt;</span><span style="color:#BD976A;">el</span><span style="color:#CB7676;">-</span><span style="color:#BD976A;">button</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">v</span><span style="color:#CB7676;">-</span><span style="color:#BD976A;">point</span><span style="color:#666666;">=</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">{key: &#39;additionalInquiryClickKey&#39;, type: &#39;click&#39;}</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">&gt;</span><span style="color:#BD976A;">追加</span><span style="color:#666666;">&lt;</span><span style="color:#CB7676;">/</span><span style="color:#BD976A;">el</span><span style="color:#CB7676;">-</span><span style="color:#BD976A;">button</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#666666;">&lt;</span><span style="color:#CB7676;">!--</span><span style="color:#DBD7CAEE;"> </span><span style="color:#80A665;">页面pv埋点</span><span style="color:#666666;">:</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">section为页面根元素</span><span style="color:#DBD7CAEE;"> </span><span style="color:#CB7676;">--</span><span style="color:#666666;">&gt;</span></span>
<span class="line"><span style="color:#666666;">&lt;</span><span style="color:#BD976A;">section</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">class</span><span style="color:#666666;">=</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">additional-inquiry</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">v</span><span style="color:#CB7676;">-</span><span style="color:#BD976A;">point</span><span style="color:#666666;">=</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">{key: &#39;additionalInquiryKey&#39;, type: &#39;pv&#39;}</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">&gt;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">const </span><span style="color:#B07D48;">Point</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;">Point</span><span style="color:#999999;">.</span><span style="color:#59873A;">install</span><span style="color:#393A34;"> </span><span style="color:#999999;">=</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Vue</span><span style="color:#393A34;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#393A34;">  </span><span style="color:#B07D48;">Vue</span><span style="color:#999999;">.</span><span style="color:#59873A;">directive</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">point</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#59873A;">inserted</span><span style="color:#999999;"> (</span><span style="color:#B07D48;">el</span><span style="color:#999999;">, </span><span style="color:#B07D48;">binding</span><span style="color:#999999;">) {</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#AB5959;">const </span><span style="color:#B07D48;">data</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">binding</span><span style="color:#999999;">.</span><span style="color:#B07D48;">value</span></span>
<span class="line"><span style="color:#999999;">      </span><span style="color:#1E754F;">if</span><span style="color:#999999;"> (</span><span style="color:#B07D48;">data</span><span style="color:#999999;">) {</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#AB5959;">const </span><span style="color:#999999;">{</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">key</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">type</span><span style="color:#AB5959;"> </span><span style="color:#999999;">}</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">data</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#B07D48;">handler</span><span style="color:#999999;">[</span><span style="color:#B07D48;">type</span><span style="color:#999999;">](</span><span style="color:#B07D48;">key</span><span style="color:#999999;">, </span><span style="color:#B07D48;">el</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#999999;">      } </span><span style="color:#1E754F;">else</span><span style="color:#999999;"> {</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#1E754F;">throw</span><span style="color:#999999;"> </span><span style="color:#AB5959;">new</span><span style="color:#999999;"> </span><span style="color:#59873A;">Error</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">请补充正确的埋点参数</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#999999;">      }</span></span>
<span class="line"><span style="color:#999999;">    }</span></span>
<span class="line"><span style="color:#999999;">  },</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">false</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;">export</span><span style="color:#393A34;"> </span><span style="color:#1E754F;">default</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">Point</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;">&lt;</span><span style="color:#AB5959;">!--</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">点击埋点</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">--</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#999999;">&lt;</span><span style="color:#B07D48;">el</span><span style="color:#AB5959;">-</span><span style="color:#B07D48;">button</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">v</span><span style="color:#AB5959;">-</span><span style="color:#B07D48;">point</span><span style="color:#999999;">=</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">{key: &#39;additionalInquiryClickKey&#39;, type: &#39;click&#39;}</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">&gt;</span><span style="color:#B07D48;">追加</span><span style="color:#999999;">&lt;</span><span style="color:#AB5959;">/</span><span style="color:#B07D48;">el</span><span style="color:#AB5959;">-</span><span style="color:#B07D48;">button</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#999999;">&lt;</span><span style="color:#AB5959;">!--</span><span style="color:#393A34;"> </span><span style="color:#59873A;">页面pv埋点</span><span style="color:#999999;">:</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">section为页面根元素</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">--</span><span style="color:#999999;">&gt;</span></span>
<span class="line"><span style="color:#999999;">&lt;</span><span style="color:#B07D48;">section</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">class</span><span style="color:#999999;">=</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">additional-inquiry</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">v</span><span style="color:#AB5959;">-</span><span style="color:#B07D48;">point</span><span style="color:#999999;">=</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">{key: &#39;additionalInquiryKey&#39;, type: &#39;pv&#39;}</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="优化方向" tabindex="-1">优化方向 <a class="header-anchor" href="#优化方向" aria-label="Permalink to &quot;优化方向&quot;">​</a></h2><p>考虑用<code>IntersectionObserver</code> 来优化页面埋点，因为 IntersectionObserver 监听 dom 元素进入可视区域，当元素进入可视区域时触发回调函数，可以用来做页面埋点。</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">const </span><span style="color:#BD976A;">options</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#B8A965;">root</span><span style="color:#666666;">: </span><span style="color:#CB7676;">null</span><span style="color:#666666;">, </span><span style="color:#758575DD;">//默认浏览器视窗</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#B8A965;">threshold</span><span style="color:#666666;">: </span><span style="color:#4C9A91;">1</span><span style="color:#666666;"> </span><span style="color:#758575DD;">//元素完全出现在浏览器视窗内才执行callback函数。</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">callback</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=(</span><span style="color:#BD976A;">entries</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">observer</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#BD976A;">entries</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">(</span><span style="color:#BD976A;">entry</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{})</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#BD976A;">observer</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> new </span><span style="color:#80A665;">IntersectionObserver</span><span style="color:#666666;">(</span><span style="color:#BD976A;">callback</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">options</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">addListenner</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">ele</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">binding</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;"> </span><span style="color:#BD976A;">observer</span><span style="color:#666666;">.</span><span style="color:#80A665;">observe</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ele</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">removeListener</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">ele</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#BD976A;">observer</span><span style="color:#666666;">.</span><span style="color:#80A665;">unobserve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ele</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#758575DD;">//自定义曝光指令</span></span>
<span class="line"><span style="color:#BD976A;">Vue</span><span style="color:#666666;">.</span><span style="color:#80A665;">directive</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">point</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">,</span><span style="color:#DBD7CAEE;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#B8A965;">bind</span><span style="color:#666666;">: </span><span style="color:#BD976A;">addListenner</span><span style="color:#666666;">,</span></span>
<span class="line"><span style="color:#666666;">  </span><span style="color:#B8A965;">unbind</span><span style="color:#666666;">: </span><span style="color:#BD976A;">removeListener</span></span>
<span class="line"><span style="color:#666666;">})</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">const </span><span style="color:#B07D48;">options</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#998418;">root</span><span style="color:#999999;">: </span><span style="color:#AB5959;">null</span><span style="color:#999999;">, </span><span style="color:#A0ADA0;">//默认浏览器视窗</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#998418;">threshold</span><span style="color:#999999;">: </span><span style="color:#2F798A;">1</span><span style="color:#999999;"> </span><span style="color:#A0ADA0;">//元素完全出现在浏览器视窗内才执行callback函数。</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">callback</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=(</span><span style="color:#B07D48;">entries</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">observer</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#B07D48;">entries</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">(</span><span style="color:#B07D48;">entry</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{})</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#B07D48;">observer</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> new </span><span style="color:#59873A;">IntersectionObserver</span><span style="color:#999999;">(</span><span style="color:#B07D48;">callback</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">options</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">addListenner</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">ele</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">binding</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;"> </span><span style="color:#B07D48;">observer</span><span style="color:#999999;">.</span><span style="color:#59873A;">observe</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ele</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">removeListener</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">ele</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#B07D48;">observer</span><span style="color:#999999;">.</span><span style="color:#59873A;">unobserve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ele</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#A0ADA0;">//自定义曝光指令</span></span>
<span class="line"><span style="color:#B07D48;">Vue</span><span style="color:#999999;">.</span><span style="color:#59873A;">directive</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">point</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">,</span><span style="color:#393A34;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#998418;">bind</span><span style="color:#999999;">: </span><span style="color:#B07D48;">addListenner</span><span style="color:#999999;">,</span></span>
<span class="line"><span style="color:#999999;">  </span><span style="color:#998418;">unbind</span><span style="color:#999999;">: </span><span style="color:#B07D48;">removeListener</span></span>
<span class="line"><span style="color:#999999;">})</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>注意，我们需要创建一个list将已经上报过的埋点信息记录下来，防止重复曝光。</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let </span><span style="color:#BD976A;">pointList</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">[];</span><span style="color:#DBD7CAEE;"> </span><span style="color:#758575DD;">//记录已经上报过的埋点信息</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">addListenner</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">ele</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">binding</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;"> </span><span style="color:#4D9375;">if</span><span style="color:#666666;">(</span><span style="color:#BD976A;">pointList</span><span style="color:#666666;">.</span><span style="color:#80A665;">indexOf</span><span style="color:#666666;">(</span><span style="color:#BD976A;">binding</span><span style="color:#666666;">.</span><span style="color:#BD976A;">value</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> !== -</span><span style="color:#4C9A91;">1</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">return</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;"> </span><span style="color:#BD976A;">observer</span><span style="color:#666666;">.</span><span style="color:#80A665;">observe</span><span style="color:#666666;">(</span><span style="color:#BD976A;">ele</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#666666;">}</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let </span><span style="color:#B07D48;">pointList</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">[];</span><span style="color:#393A34;"> </span><span style="color:#A0ADA0;">//记录已经上报过的埋点信息</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">addListenner</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">ele</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">binding</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;"> </span><span style="color:#1E754F;">if</span><span style="color:#999999;">(</span><span style="color:#B07D48;">pointList</span><span style="color:#999999;">.</span><span style="color:#59873A;">indexOf</span><span style="color:#999999;">(</span><span style="color:#B07D48;">binding</span><span style="color:#999999;">.</span><span style="color:#B07D48;">value</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> !== -</span><span style="color:#2F798A;">1</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">return</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;"> </span><span style="color:#B07D48;">observer</span><span style="color:#999999;">.</span><span style="color:#59873A;">observe</span><span style="color:#999999;">(</span><span style="color:#B07D48;">ele</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#999999;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们将要上报的信息绑定在目标元素的 &#39;point-data&#39; 属性中，当目标元素出现在视窗内时，并停留 5 秒以上(或者规定记录秒数时)时，上报埋点信息。</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#CB7676;">let </span><span style="color:#BD976A;">timer</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{}</span><span style="color:#CB7676;"> </span><span style="color:#758575DD;">//增加定时器对象</span></span>
<span class="line"><span style="color:#CB7676;">const </span><span style="color:#80A665;">callback</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">entries</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#BD976A;">entries</span><span style="color:#666666;">.</span><span style="color:#80A665;">forEach</span><span style="color:#666666;">(</span><span style="color:#BD976A;">entry</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">    let </span><span style="color:#BD976A;">pointData</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> null</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">try</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">pointData</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">JSON</span><span style="color:#666666;">.</span><span style="color:#80A665;">parse</span><span style="color:#666666;">(</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">.</span><span style="color:#BD976A;">target</span><span style="color:#666666;">.</span><span style="color:#80A665;">getAttribute</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">point-data</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">))</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#666666;">}</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">catch</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">e</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">pointData</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> null</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">console</span><span style="color:#666666;">.</span><span style="color:#80A665;">error</span><span style="color:#666666;">(</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#C98A7D;">埋点数据格式异常</span><span style="color:#C98A7D99;">&#39;</span><span style="color:#666666;">,</span><span style="color:#CB7676;"> </span><span style="color:#BD976A;">e</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#666666;">    </span><span style="color:#758575DD;">//没有埋点数据取消上报</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">if</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#CB7676;">!</span><span style="color:#BD976A;">pointData</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">observer</span><span style="color:#666666;">.</span><span style="color:#80A665;">unobserve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">.</span><span style="color:#BD976A;">target</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#4D9375;">return</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">if</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">.</span><span style="color:#BD976A;">isIntersecting</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">timer</span><span style="color:#666666;">[</span><span style="color:#BD976A;">pointData</span><span style="color:#666666;">.</span><span style="color:#BD976A;">id</span><span style="color:#666666;">]</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> </span><span style="color:#80A665;">setTimeout</span><span style="color:#666666;">(</span><span style="color:#CB7676;">function</span><span style="color:#666666;">()</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">        </span><span style="color:#758575DD;">//上报埋点信息</span></span>
<span class="line"><span style="color:#CB7676;">        </span><span style="color:#80A665;">sendUtm</span><span style="color:#666666;">(</span><span style="color:#BD976A;">pointData</span><span style="color:#666666;">).</span><span style="color:#80A665;">then</span><span style="color:#666666;">(</span><span style="color:#BD976A;">res</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=&gt;</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">          </span><span style="color:#4D9375;">if</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">res</span><span style="color:#666666;">.</span><span style="color:#BD976A;">success</span><span style="color:#666666;">)</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#666666;">            </span><span style="color:#758575DD;">//上报成功后取消监听</span></span>
<span class="line"><span style="color:#CB7676;">            </span><span style="color:#BD976A;">observer</span><span style="color:#666666;">.</span><span style="color:#80A665;">unobserve</span><span style="color:#666666;">(</span><span style="color:#BD976A;">entry</span><span style="color:#666666;">.</span><span style="color:#BD976A;">target</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">            </span><span style="color:#BD976A;">visuallyList</span><span style="color:#666666;">.</span><span style="color:#80A665;">push</span><span style="color:#666666;">(</span><span style="color:#BD976A;">pointData</span><span style="color:#666666;">.</span><span style="color:#BD976A;">id</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">            </span><span style="color:#BD976A;">timer</span><span style="color:#666666;">[</span><span style="color:#BD976A;">pointData</span><span style="color:#666666;">.</span><span style="color:#BD976A;">id</span><span style="color:#666666;">]</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> null</span></span>
<span class="line"><span style="color:#CB7676;">          </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">        </span><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#666666;">},</span><span style="color:#CB7676;"> </span><span style="color:#4C9A91;">5000</span><span style="color:#666666;">)</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#666666;">}</span><span style="color:#CB7676;"> </span><span style="color:#4D9375;">else</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#4D9375;">if</span><span style="color:#CB7676;"> </span><span style="color:#666666;">(</span><span style="color:#BD976A;">timer</span><span style="color:#666666;">[</span><span style="color:#BD976A;">pointData</span><span style="color:#666666;">.</span><span style="color:#BD976A;">id</span><span style="color:#666666;">])</span><span style="color:#CB7676;"> </span><span style="color:#666666;">{</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#80A665;">clearTimeout</span><span style="color:#666666;">(</span><span style="color:#BD976A;">timer</span><span style="color:#666666;">[</span><span style="color:#BD976A;">pointData</span><span style="color:#666666;">.</span><span style="color:#BD976A;">id</span><span style="color:#666666;">])</span></span>
<span class="line"><span style="color:#CB7676;">      </span><span style="color:#BD976A;">timer</span><span style="color:#666666;">[</span><span style="color:#BD976A;">pointData</span><span style="color:#666666;">.</span><span style="color:#BD976A;">id</span><span style="color:#666666;">]</span><span style="color:#CB7676;"> </span><span style="color:#666666;">=</span><span style="color:#CB7676;"> null</span></span>
<span class="line"><span style="color:#CB7676;">    </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#666666;">}</span></span>
<span class="line"><span style="color:#CB7676;">  </span><span style="color:#666666;">})</span></span>
<span class="line"><span style="color:#666666;">}</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#AB5959;">let </span><span style="color:#B07D48;">timer</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{}</span><span style="color:#AB5959;"> </span><span style="color:#A0ADA0;">//增加定时器对象</span></span>
<span class="line"><span style="color:#AB5959;">const </span><span style="color:#59873A;">callback</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">entries</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#B07D48;">entries</span><span style="color:#999999;">.</span><span style="color:#59873A;">forEach</span><span style="color:#999999;">(</span><span style="color:#B07D48;">entry</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">    let </span><span style="color:#B07D48;">pointData</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> null</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">try</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">pointData</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">JSON</span><span style="color:#999999;">.</span><span style="color:#59873A;">parse</span><span style="color:#999999;">(</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">.</span><span style="color:#B07D48;">target</span><span style="color:#999999;">.</span><span style="color:#59873A;">getAttribute</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">point-data</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">))</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#999999;">}</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">catch</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">e</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">pointData</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> null</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">console</span><span style="color:#999999;">.</span><span style="color:#59873A;">error</span><span style="color:#999999;">(</span><span style="color:#B5695999;">&#39;</span><span style="color:#B56959;">埋点数据格式异常</span><span style="color:#B5695999;">&#39;</span><span style="color:#999999;">,</span><span style="color:#AB5959;"> </span><span style="color:#B07D48;">e</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#999999;">    </span><span style="color:#A0ADA0;">//没有埋点数据取消上报</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">if</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#AB5959;">!</span><span style="color:#B07D48;">pointData</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">observer</span><span style="color:#999999;">.</span><span style="color:#59873A;">unobserve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">.</span><span style="color:#B07D48;">target</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#1E754F;">return</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">if</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">.</span><span style="color:#B07D48;">isIntersecting</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">timer</span><span style="color:#999999;">[</span><span style="color:#B07D48;">pointData</span><span style="color:#999999;">.</span><span style="color:#B07D48;">id</span><span style="color:#999999;">]</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> </span><span style="color:#59873A;">setTimeout</span><span style="color:#999999;">(</span><span style="color:#AB5959;">function</span><span style="color:#999999;">()</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">        </span><span style="color:#A0ADA0;">//上报埋点信息</span></span>
<span class="line"><span style="color:#AB5959;">        </span><span style="color:#59873A;">sendUtm</span><span style="color:#999999;">(</span><span style="color:#B07D48;">pointData</span><span style="color:#999999;">).</span><span style="color:#59873A;">then</span><span style="color:#999999;">(</span><span style="color:#B07D48;">res</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=&gt;</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">          </span><span style="color:#1E754F;">if</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">res</span><span style="color:#999999;">.</span><span style="color:#B07D48;">success</span><span style="color:#999999;">)</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#999999;">            </span><span style="color:#A0ADA0;">//上报成功后取消监听</span></span>
<span class="line"><span style="color:#AB5959;">            </span><span style="color:#B07D48;">observer</span><span style="color:#999999;">.</span><span style="color:#59873A;">unobserve</span><span style="color:#999999;">(</span><span style="color:#B07D48;">entry</span><span style="color:#999999;">.</span><span style="color:#B07D48;">target</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">            </span><span style="color:#B07D48;">visuallyList</span><span style="color:#999999;">.</span><span style="color:#59873A;">push</span><span style="color:#999999;">(</span><span style="color:#B07D48;">pointData</span><span style="color:#999999;">.</span><span style="color:#B07D48;">id</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">            </span><span style="color:#B07D48;">timer</span><span style="color:#999999;">[</span><span style="color:#B07D48;">pointData</span><span style="color:#999999;">.</span><span style="color:#B07D48;">id</span><span style="color:#999999;">]</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> null</span></span>
<span class="line"><span style="color:#AB5959;">          </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">        </span><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#999999;">},</span><span style="color:#AB5959;"> </span><span style="color:#2F798A;">5000</span><span style="color:#999999;">)</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#999999;">}</span><span style="color:#AB5959;"> </span><span style="color:#1E754F;">else</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#1E754F;">if</span><span style="color:#AB5959;"> </span><span style="color:#999999;">(</span><span style="color:#B07D48;">timer</span><span style="color:#999999;">[</span><span style="color:#B07D48;">pointData</span><span style="color:#999999;">.</span><span style="color:#B07D48;">id</span><span style="color:#999999;">])</span><span style="color:#AB5959;"> </span><span style="color:#999999;">{</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#59873A;">clearTimeout</span><span style="color:#999999;">(</span><span style="color:#B07D48;">timer</span><span style="color:#999999;">[</span><span style="color:#B07D48;">pointData</span><span style="color:#999999;">.</span><span style="color:#B07D48;">id</span><span style="color:#999999;">])</span></span>
<span class="line"><span style="color:#AB5959;">      </span><span style="color:#B07D48;">timer</span><span style="color:#999999;">[</span><span style="color:#B07D48;">pointData</span><span style="color:#999999;">.</span><span style="color:#B07D48;">id</span><span style="color:#999999;">]</span><span style="color:#AB5959;"> </span><span style="color:#999999;">=</span><span style="color:#AB5959;"> null</span></span>
<span class="line"><span style="color:#AB5959;">    </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#999999;">}</span></span>
<span class="line"><span style="color:#AB5959;">  </span><span style="color:#999999;">})</span></span>
<span class="line"><span style="color:#999999;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>在代码中可以直接使用指令实现曝光埋点了：</p><div class="language-html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki vitesse-dark vp-code-dark"><code><span class="line"><span style="color:#666666;">&lt;</span><span style="color:#4D9375;">div</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">v-point</span><span style="color:#666666;">=</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">pointData.id</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#DBD7CAEE;"> </span><span style="color:#BD976A;">:point-data</span><span style="color:#666666;">=</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#C98A7D;">JSON.stringify(pointData)</span><span style="color:#C98A7D99;">&quot;</span><span style="color:#666666;">&gt;&lt;/</span><span style="color:#4D9375;">div</span><span style="color:#666666;">&gt;</span></span></code></pre><pre class="shiki vitesse-light vp-code-light"><code><span class="line"><span style="color:#999999;">&lt;</span><span style="color:#1E754F;">div</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">v-point</span><span style="color:#999999;">=</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">pointData.id</span><span style="color:#B5695999;">&quot;</span><span style="color:#393A34;"> </span><span style="color:#B07D48;">:point-data</span><span style="color:#999999;">=</span><span style="color:#B5695999;">&quot;</span><span style="color:#B56959;">JSON.stringify(pointData)</span><span style="color:#B5695999;">&quot;</span><span style="color:#999999;">&gt;&lt;/</span><span style="color:#1E754F;">div</span><span style="color:#999999;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="数据怎么去重" tabindex="-1">数据怎么去重 <a class="header-anchor" href="#数据怎么去重" aria-label="Permalink to &quot;数据怎么去重&quot;">​</a></h2><p>从<code>error</code>里面的<code>message</code>和<code>stack</code>组成<code>key</code>，根据这个<code>key</code>去重</p><h2 id="数据格式" tabindex="-1">数据格式 <a class="header-anchor" href="#数据格式" aria-label="Permalink to &quot;数据格式&quot;">​</a></h2>`,39),e=[o];function t(r,c,y,i,B,A){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{b as __pageData,d as default};
